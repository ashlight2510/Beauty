#!/usr/bin/env node

/**
 * í…ŒìŠ¤íŠ¸ ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 * Usage: yarn create-test <test-id> "<Test Title>"
 * Example: yarn create-test coffee-addiction "ì»¤í”¼ ì¤‘ë…ë„ í…ŒìŠ¤íŠ¸"
 */

import * as fs from 'fs';
import * as path from 'path';

const args = process.argv.slice(2);

if (args.length < 2) {
  console.error('Usage: yarn create-test <test-id> "<Test Title>"');
  console.error('Example: yarn create-test coffee-addiction "ì»¤í”¼ ì¤‘ë…ë„ í…ŒìŠ¤íŠ¸"');
  process.exit(1);
}

const [testId, title] = args;

// testId ê²€ì¦
if (!/^[a-z0-9-]+$/.test(testId)) {
  console.error('Error: test-idëŠ” ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  process.exit(1);
}

const projectRoot = path.join(__dirname, '..');
const testDir = path.join(projectRoot, 'tests', testId);
const templateConfigPath = path.join(projectRoot, 'tests', 'beauty-bankruptcy', 'config.json');

// í…œí”Œë¦¿ config ì½ê¸°
if (!fs.existsSync(templateConfigPath)) {
  console.error(`Error: í…œí”Œë¦¿ configë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${templateConfigPath}`);
  process.exit(1);
}

const templateConfig = JSON.parse(fs.readFileSync(templateConfigPath, 'utf-8'));

// ìƒˆ config ìƒì„±
const newConfig = {
  ...templateConfig,
  id: testId,
  title: title,
  subtitle: `${title} Test`,
  description: `${title}ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.`,
  subDescription: `ì´ ${templateConfig.questions.length}ê°œì˜ ì§ˆë¬¸ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.`,
  scoringMethod: 'beauty_default', // ê¸°ë³¸ê°’, ë‚˜ì¤‘ì— ìˆ˜ì • ê°€ëŠ¥
  questions: templateConfig.questions.map((q: any) => ({
    ...q,
    title: q.title.replace('Q1.', `Q${templateConfig.questions.indexOf(q) + 1}.`),
  })),
  resultMessages: [
    'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë©”ì‹œì§€ 1',
    'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë©”ì‹œì§€ 2',
    'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë©”ì‹œì§€ 3',
  ],
};

// ë””ë ‰í† ë¦¬ ìƒì„±
if (!fs.existsSync(testDir)) {
  fs.mkdirSync(testDir, { recursive: true });
  console.log(`âœ… Created directory: tests/${testId}`);
} else {
  console.error(`Error: tests/${testId} ë””ë ‰í† ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
  process.exit(1);
}

// config.json ìƒì„±
const configPath = path.join(testDir, 'config.json');
fs.writeFileSync(configPath, JSON.stringify(newConfig, null, 2), 'utf-8');
console.log(`âœ… Created config.json: tests/${testId}/config.json`);

// generate.tsì˜ KNOWN_TESTS ë°°ì—´ì— ìƒˆ í…ŒìŠ¤íŠ¸ ì¶”ê°€
const generatePath = path.join(projectRoot, 'lib', 'generate.ts');
if (fs.existsSync(generatePath)) {
  let generateContent = fs.readFileSync(generatePath, 'utf-8');
  
  // KNOWN_TESTS ë°°ì—´ì— ìƒˆ í…ŒìŠ¤íŠ¸ ì¶”ê°€
  const knownTestsPattern = /const KNOWN_TESTS = \[(.*?)\];/s;
  const match = generateContent.match(knownTestsPattern);
  if (match) {
    const existingTests = match[1]
      .split(',')
      .map((t) => t.trim().replace(/['"]/g, ''))
      .filter((t) => t);
    
    if (!existingTests.includes(testId)) {
      existingTests.push(testId);
      const newTestsArray = `const KNOWN_TESTS = [${existingTests.map((t) => `'${t}'`).join(', ')}];`;
      generateContent = generateContent.replace(knownTestsPattern, newTestsArray);
      fs.writeFileSync(generatePath, generateContent, 'utf-8');
      console.log(`âœ… Updated lib/generate.ts`);
    }
  } else {
    // íŒ¨í„´ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°, ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€ ì‹œë„
    const fallbackPattern = /const KNOWN_TESTS = \[.*?\];/;
    if (fallbackPattern.test(generateContent)) {
      console.log(`âš ï¸  KNOWN_TESTS íŒ¨í„´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
    }
  }
}

console.log('\nğŸ‰ í…ŒìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ!');
console.log(`\në‹¤ìŒ ë‹¨ê³„:`);
console.log(`1. tests/${testId}/config.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ì§ˆë¬¸ê³¼ ì„ íƒì§€ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ì„¸ìš”.`);
console.log(`2. í•„ìš”ì‹œ lib/scoring.tsì— ìƒˆë¡œìš´ scoringMethodë¥¼ ì¶”ê°€í•˜ì„¸ìš”.`);
console.log(`3. ë¸Œë¼ìš°ì €ì—ì„œ /${testId} ê²½ë¡œë¡œ ì ‘ì†í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
console.log(`\ní…ŒìŠ¤íŠ¸ URL: http://localhost:3000/${testId}`);

